version: '3.8'

services:
  go-anta:
    build:
      context: .
      dockerfile: Dockerfile
    image: go-anta:latest
    container_name: go-anta
    environment:
      # Logging configuration
      - GANTA_LOG_LEVEL=${LOG_LEVEL:-info}
      - GANTA_LOG_FILE=${LOG_FILE:-}
      
      # Device connection settings
      - GANTA_DEVICE_TIMEOUT=${DEVICE_TIMEOUT:-30s}
      - GANTA_DEVICE_MAX_CONNECTIONS=${MAX_CONNECTIONS:-100}
      - GANTA_DEVICE_RETRY_ATTEMPTS=${RETRY_ATTEMPTS:-3}
      - GANTA_DEVICE_RETRY_DELAY=${RETRY_DELAY:-5s}
      
      # Test execution settings
      - GANTA_TEST_MAX_CONCURRENCY=${TEST_CONCURRENCY:-10}
      - GANTA_TEST_CACHE_TTL=${CACHE_TTL:-60s}
      - GANTA_TEST_CACHE_SIZE=${CACHE_SIZE:-128}
      
      # Reporter settings
      - GANTA_REPORTER_DEFAULT_FORMAT=${OUTPUT_FORMAT:-table}
      - GANTA_REPORTER_OUTPUT_FILE=${OUTPUT_FILE:-}
      
      # Optional: Device credentials (use secrets in production)
      - DEVICE_USERNAME=${DEVICE_USERNAME:-}
      - DEVICE_PASSWORD=${DEVICE_PASSWORD:-}
    
    volumes:
      # Mount local inventory and catalog files
      - ./inventory.yaml:/data/inventory.yaml:ro
      - ./catalog.yaml:/data/catalog.yaml:ro
      
      # Mount config directory
      - ./config:/config:ro
      
      # Mount output directory for results
      - ./output:/data/output
      
      # Optional: Mount custom tests directory
      - ./custom-tests:/app/custom-tests:ro
    
    # Network mode host for direct device access
    # Change to bridge if using specific network configuration
    network_mode: host
    
    # Command to run NRFU tests
    command: ["nrfu", "-i", "/data/inventory.yaml", "-c", "/data/catalog.yaml"]
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

  # Optional: Run as a periodic job using cron-like scheduler
  go-anta-scheduled:
    build:
      context: .
      dockerfile: Dockerfile
    image: go-anta:latest
    container_name: go-anta-scheduled
    environment:
      - GANTA_LOG_LEVEL=${LOG_LEVEL:-info}
      - DEVICE_USERNAME=${DEVICE_USERNAME:-}
      - DEVICE_PASSWORD=${DEVICE_PASSWORD:-}
    volumes:
      - ./inventory.yaml:/data/inventory.yaml:ro
      - ./catalog.yaml:/data/catalog.yaml:ro
      - ./output:/data/output
      - ./scripts/scheduled-run.sh:/app/scheduled-run.sh:ro
    network_mode: host
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "while true; do
        echo 'Running GANTA tests at $$(date)'
        /app/go-anta nrfu -i /data/inventory.yaml -c /data/catalog.yaml -f json -o /data/output/results-$$(date +%Y%m%d-%H%M%S).json
        echo 'Tests completed. Sleeping for 1 hour...'
        sleep 3600
      done"
    restart: unless-stopped

  # Optional: Web UI for viewing results (using nginx)
  go-anta-ui:
    image: nginx:alpine
    container_name: go-anta-ui
    ports:
      - "8080:80"
    volumes:
      - ./output:/usr/share/nginx/html:ro
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - go-anta
    restart: unless-stopped

networks:
  default:
    name: go-anta-network
    driver: bridge

volumes:
  go-anta-data:
    name: go-anta-data
  go-anta-output:
    name: go-anta-output